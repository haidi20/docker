def withDockerNetwork(Closure inner) {
   try {
      sh "docker run -itd --network=nginx_network db"
      inner.call("nginx_network")
    } finally {
      // sh "docker network rm nginx_network"
    }
  }

pipeline {
  agent {
    label '!windows'
  }

  environment {
    DEBUG = 1
    POSTGRES_DB = djangoapp
    POSTGRES_USER = root
    POSTGRES_PASSWORD = root
    POSTGRES_HOST = db
    POSTGRES_PORT = 5432
  }

  stages {
    stage("build") {
      steps {
        sh 'echo deploy'
      }
    }

    stage("test") {
      agent any

      steps {
        script {
          // image local
          def database = docker.image('db')
          def app = docker.image('api')

          withDockerNetwork{ n ->
            database.withRun("--network ${n} --name database") { c ->
              app.inside("""
                --network ${n}
              """) {
                sh 'python app/manage.py test ./app'
              }
            }
          }
        }
      }
    }

    stage("deploy") {
      steps {
        sh 'echo deploy'
      }
    }
  }
}